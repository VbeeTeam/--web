<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首页</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/common.css" />
    <style>
        table td {
            vertical-align: middle !important;
        }
    </style>
</head>

<body>
    <header>
        <h3 class="text-center text-white bg-secondary py-3 m-0">图书管理系统</h3>
    </header>
    <section>
        <form class="form-inline bg-dark d-flex justify-content-center py-3">
            <div class="form-group mx-sm-3">
                <label class="text-white mx-3">请输入图书名称搜索</label>
                <input type="text" class="form-control" id="nameId" placeholder="请输入图书名称">
            </div>
            <input class="btn bg-primary text-white" type="button" id="btnId" value="搜索" />
            <!-- <a class="btn bg-secondary text-white ml-3" href="add.html">添加</a> -->
            <input class="btn bg-secondary text-white ml-3" type="button" id="addId" value="添加" />
        </form>
        <table class="table table-striped table-dark">
            <thead>
                <tr>
                    <th scope="col">序号</th>
                    <th scope="col">名称</th>
                    <th scope="col">图片</th>
                    <th scope="col">作者</th>
                    <th scope="col">分类</th>
                    <th scope="col">描述</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody id="tbId"></tbody>
        </table>
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
                <li class="page-item" id="prevId">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item" id="pageId"><a class="page-link" href="#">1</a></li>
                <li class="page-item" id="nextId">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </section>
    <div class="container">
        <div class="text-center toastClass text-white" id="toastId">
            删除成功！
        </div>
    </div>
</body>

</html>
<script src="js/jquery3.6.0_min.js"></script>
<script>
    // 页面加载完成使用ajax请求图书列表接口渲染图书列表
    $(function () {
        // 渲染列表
        getList();
        // 搜索图书
        $("#btnId").click(function () {
            getList();
        })
        // 跳转到添加页面
        $("#addId").click(function () {
            location.href = "add.html";
        })
        // 删除数据
        $("body").on("click", ".del", function () {
            if (confirm("确认删除吗？")) {
                // console.log($(this).parent().parent().index());
                var trDom = $(this).parent().parent();
                // 获取当前行下标
                let index = $(this).parent().parent().index();
                console.log(arr[index].id);
                $.ajax({
                    type: "DELETE",
                    url: "http://127.0.0.1:3000/del",
                    data: {
                        id: arr[index].id
                    },
                    success: function (res) {
                        console.log(res);
                        if (res.code == 200) {
                            // 删除提示显示
                            $("#toastId").animate({
                                top: "100px"
                            }, 1000, function () {
                                // 删除当前行
                                trDom.remove();
                                // 删除存储数组中的元素数据
                                arr.splice(index, 1);

                                $("#toastId").animate({
                                    top: "-100px"
                                }, 2000);
                            })
                        }
                    },
                    error: function (err) {
                        console.log("服务器错误");
                    }
                })
            }
        })
        // 分页
        $("#prevId").click(function () {
            console.log("点击上一页")
            if (page > 1) {
                page -= 1;
                getList();
            }
            console.log(page);

        })
        $("#nextId").click(function () {
            console.log("点击下一页");
            if (page < total / 5) {
                page += 1;
                // getList();
            }
            console.log(page);
            console.log(total)
           
        })
    })
    // 公共ajax获取列表方法
    var arr = [];
    var page = 1;
    var total = 0;
    function getList() {
        $.ajax({
            type: 'GET',
            data: {
                name: $("#nameId").val(),
                page: page
            },
            url: "http://localhost:3000/list",
            success: function (res) {
                console.log(res);
                if (res.code == 200) {
                    // 追加元素之前删除之前渲染的渲染
                    $("#tbId tr").remove();
                    arr = res.data;
                    total = res.total;
                    console.log(arr);
                    $.each(arr, function (index, item) {
                        $(`<tr><td scope="row">${item.id}</td><td>${item.name}</td><td><img width="80" height="80" src="${item.imgUrl}" alt="没有图片" /></td><td>${item.author}</td><td>${item.categroy}</td>
                            <td>${item.description}</td><td><a href="edit.html?id=${item.id}">修改</a> | <a href="#" class="del">删除</a></td></tr>`).appendTo($("#tbId"));
                    })
                }
            },
            error: function (err) {
                console.log("服务器错误")
            }
        })
    }

</script>